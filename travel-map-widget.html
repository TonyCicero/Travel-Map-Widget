<!DOCTYPE html>
<html>
<head>
  <style>
    #map-container {
      width: 100%;
      height: 500px;
      position: relative;
    }
    #flat-map, #globe {
      width: 100%;
      height: 100%;
      display: none;
    }
    #flat-map.active, #globe.active {
      display: block;
    }
    /* Toggle switch styles */
    .toggle-container {
      position: absolute;
      top: 10px;
      right: 10px; /* Right-aligned */
      z-index: 1000;
    }
    #toggle-btn {
      display: none; /* Hide checkbox */
    }
    .toggle-label {
      display: inline-block;
      width: 100px;
      height: 40px;
      background: #0073aa;
      border-radius: 5px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-label::before {
      content: '';
      position: absolute;
      width: 45px;
      height: 35px;
      background: white;
      border-radius:5px;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    #toggle-btn:checked + .toggle-label {
      background: #005177; /* Hover/active color */
    }
    #toggle-btn:checked + .toggle-label::before {
      transform: translateX(45px); /* Slide to right when checked (globe) */
    }
    .toggle-text {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      font-size: 12px;
      user-select: none;
    }
    .toggle-text.map {
      left: 8px;
    }
    .toggle-text.globe {
      right: 8px;
    }
    .leaflet-popup-content {
      font-size: 14px;
    }
    #error-message {
      display: none;
      color: red;
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
  <!-- Leaflet.js for flat map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Three.js and Globe.GL for 3D globe -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl@2.27.0/dist/globe.gl.min.js"></script>
</head>
<body>
  <div id="map-container">
    <div class="toggle-container">
      <input type="checkbox" id="toggle-btn" aria-label="Toggle between flat map and globe">
      <label for="toggle-btn" class="toggle-label">
        <span class="toggle-text map">Map</span>
        <span class="toggle-text globe">Globe</span>
      </label>
    </div>
    <div id="error-message"></div>
    <div id="flat-map" class="active"></div>
    <div id="globe"></div>
  </div>

  <script>
    // WordPress base URL (use wp_localize_script in production)
    const baseUrl = window.location.origin;

    // GeoJSON URLs
    const countryGeoJsonUrl = 'https://raw.githubusercontent.com/TonyCicero/Map-Widget/refs/heads/main/world.geo.json';
    const usStatesGeoJsonUrl = 'https://raw.githubusercontent.com/TonyCicero/Map-Widget/refs/heads/main/us_states.geo.json';

    // Array of countries and US states to display
    const displayedLocations = [
	
		// US States
		'California',
		'Florida',
		'Maryland',
		'Massachusetts',
		'New York',
		'Nevada',
		'Pennsylvania',
		'Virginia',
	
		// Countries
		'Albania',
		'Austria',
		'Belgium',
		'Cambodia',
		'Canada',
		'Czech Republic',
		'Denmark',
		'Dominican Rep.',
		'France',
		'Germany',
		'Greece',
		'Ireland',
		'Japan',
		'Laos',
		'Netherlands',
		'Poland',
		'Slovakia',
		'Sweden',
		'Switzerland',
		'Thailand',
		'United Kingdom',
		'United States of America',
		'Vietnam',
    ];

    // Error display function
    const showError = (message) => {
      const errorDiv = document.getElementById('error-message');
      errorDiv.style.display = 'block';
      errorDiv.textContent = message;
    };

    // Validate GeoJSON geometry
    const isValidGeometry = (geometry) => {
      if (!geometry || !geometry.type || !geometry.coordinates) return false;
      if (geometry.type === 'Polygon' || geometry.type === 'MultiPolygon') {
        const coords = geometry.type === 'Polygon' ? [geometry.coordinates] : geometry.coordinates;
        for (const poly of coords) {
          for (const ring of poly) {
            for (const [lon, lat] of ring) {
              if (Math.abs(lon) > 180 || Math.abs(lat) > 90) return false;
            }
          }
        }
      }
      return true;
    };

    // Initialize Flat Map (Leaflet)
    const flatMap = L.map('flat-map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18,
	  minZoom: 2
    }).addTo(flatMap);

    // Load and render countries for flat map
    fetch(countryGeoJsonUrl)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}: Failed to load countries GeoJSON`);
        return response.json();
      })
      .then(data => {
        if (!data.features) throw new Error('Invalid GeoJSON: No features found');
        // Filter by displayedLocations and valid geometries
        data.features = data.features.filter(feature => 
          isValidGeometry(feature.geometry) && 
          displayedLocations.includes(feature.properties.name)
        );
        if (data.features.length === 0) {
          showError('No matching countries found in GeoJSON.');
          return;
        }
        var geoLayer = L.geoJSON(data, {
          style: {
            fillColor: '#9000b4',
            weight: 2,
            opacity: 1,
            color: 'white',
            fillOpacity: 0.3 // Increased transparency
          },
          onEachFeature: (feature, layer) => {
            const name = feature.properties.name || 'Unknown';
            const slug = name.toLowerCase().replace(/\s+/g, '-');
            layer.bindPopup(name);
            layer.on('click', () => {
              window.location.href = `${baseUrl}/wp/location/${slug}`;
            });
          }
        })
		geoLayer.addTo(flatMap);
		var geoLayerBounds = geoLayer.getBounds();
		flatMap.fitBounds(geoLayerBounds);
      })
      .catch(error => {
        console.error('Error loading country GeoJSON:', error);
        showError('Failed to load country map data. Please try refreshing.');
      });

    // Load and render US states for flat map
    fetch(usStatesGeoJsonUrl)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}: Failed to load US states GeoJSON`);
        return response.json();
      })
      .then(data => {
        if (!data.features) throw new Error('Invalid GeoJSON: No features found');
        // Filter by displayedLocations and valid geometries
        data.features = data.features.filter(feature => 
          isValidGeometry(feature.geometry) && 
          displayedLocations.includes(feature.properties.name)
        );
        if (data.features.length === 0) {
          showError('No matching US states found in GeoJSON.');
          return;
        }
        L.geoJSON(data, {
          style: {
            fillColor: '#00aaff',
            weight: 1,
            opacity: 1,
            color: 'white',
            fillOpacity: 0.3 // Increased transparency
          },
          onEachFeature: (feature, layer) => {
            const name = feature.properties.name || 'Unknown';
            const slug = name.toLowerCase().replace(/\s+/g, '-');
            layer.bindPopup(name);
            layer.on('click', () => {
              window.location.href = `${baseUrl}/wp/location/${slug}`;
            });
          }
        }).addTo(flatMap);
      })
      .catch(error => {
        console.error('Error loading US states GeoJSON:', error);
        showError('Failed to load US states map data. Please try refreshing.');
      });

    // Initialize Globe (Globe.GL)
    const globe = Globe()
	  .height(500)
      .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
      .backgroundColor('#000000')
      .polygonsData([])
      .polygonCapColor(() => 'rgba(145, 0, 180, 0.3)') // Increased transparency
      .polygonSideColor(() => 'rgba(0, 100, 0, 0.15)')
      .polygonStrokeColor(() => '#111')
      .polygonLabel(({ properties }) => `<b>${properties.name || 'Unknown'}</b>`)
      .onPolygonClick(({ properties }) => {
        const name = properties.name || 'unknown';
        const slug = name.toLowerCase().replace(/\s+/g, '-');
        window.location.href = `${baseUrl}/wp/location/${slug}`;
      })
      (document.getElementById('globe'));
	  
	  globe.pointOfView({ lat: 39, lng: -76, altitude: 2.5 }, 0)

    // Load GeoJSON for globe
    fetch(countryGeoJsonUrl)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}: Failed to load countries GeoJSON for globe`);
        return response.json();
      })
      .then(data => {
        if (!data.features) throw new Error('Invalid GeoJSON: No features found');
        // Filter by displayedLocations and valid geometries
        data.features = data.features.filter(feature => 
          isValidGeometry(feature.geometry) && 
          displayedLocations.includes(feature.properties.name)
        );
        if (data.features.length === 0) {
          showError('No matching countries found for globe.');
          return;
        }
        globe.polygonsData(data.features);
      })
      .catch(error => {
        console.error('Error loading country GeoJSON for globe:', error);
        showError('Failed to load globe data. Please try refreshing.');
      });

    // Toggle between flat map and globe
    const toggleBtn = document.getElementById('toggle-btn');
    const flatMapDiv = document.getElementById('flat-map');
    const globeDiv = document.getElementById('globe');

    toggleBtn.addEventListener('click', () => {
      if (flatMapDiv.classList.contains('active')) {
        flatMapDiv.classList.remove('active');
        globeDiv.classList.add('active');
        toggleBtn.textContent = 'Switch to Flat Map';
        flatMap.invalidateSize();
      } else {
        globeDiv.classList.remove('active');
        flatMapDiv.classList.add('active');
        toggleBtn.textContent = 'Switch to Globe';
        flatMap.invalidateSize();
      }
    });
  </script>
</body>
</html>